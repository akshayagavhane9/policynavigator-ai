<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PolicyNavigator AI ‚Äì Policy Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
  <!-- ================= NAVBAR ================= -->
  <header class="navbar">
    <div class="nav-inner">
      <div class="nav-left">
        <!-- Logo: remove gradient ‚Äúlogo-mark‚Äù box look by using plain image container -->
        <div style="display:flex; align-items:center; gap:12px;">
          <img
            src="src/images/logo.png"
            onerror="this.onerror=null; this.src='images/logo.png';"
            alt="PolicyNavigator AI Logo"
            class="logo-img"
            style="width:44px;height:44px;object-fit:contain;border-radius:12px;"
          />
          <div class="logo-text">
            <div class="logo-title">PolicyNavigator AI</div>
            <div class="logo-sub">Policy Assistant ¬∑ RAG + LLM</div>
          </div>
        </div>
      </div>

      <nav class="nav-links">
        <a href="#hero" class="nav-link active">Home</a>
        <a href="#features" class="nav-link">Features</a>
        <a href="#how-it-works" class="nav-link">How it Works</a>
        <a href="#demo" class="nav-link">Demo</a>
        <a href="#metrics" class="nav-link">Metrics</a>
        <a href="#team-docs" class="nav-link">Team & Docs</a>
      </nav>

      <a
        href="https://github.com/akshayagavhane9/policynavigator-ai"
        target="_blank"
        class="nav-cta"
      >
        View on GitHub
      </a>
    </div>
  </header>

  <main>
    <!-- ================ HERO =================== -->
    <section id="hero" class="section hero">
      <div class="hero-inner">
        <div class="hero-left">
          <div class="hero-pill-row">
            <span class="pill pill-outline">
              ‚ö° Built with RAG, Prompt Engineering &amp; Synthetic Evaluation
            </span>
          </div>

          <!-- Make headline look like your reference screenshot by forcing a larger size here -->
          <h1 class="hero-title" style="font-size:64px; line-height:1.02; letter-spacing:-0.02em;">
            Understand <br />
            policies<span class="hero-highlight"> in plain</span><br />
            <span class="hero-highlight">English.</span>
          </h1>

          <p class="hero-subtitle" style="font-size:16px; max-width:640px;">
            PolicyNavigator AI is a retrieval-augmented assistant that answers policy
            questions, explains student rights, simulates what-if scenarios, and even
            quizzes you ‚Äî grounded in the exact policy PDFs you upload.
          </p>

          <!-- Buttons: use smaller existing button system (not the huge -lg ones) -->
          <div class="hero-actions" style="display:flex; gap:14px; flex-wrap:wrap;">
            <button id="cta-demo" class="btn btn-primary btn-large" type="button">
              Try the Live Demo <span class="arrow">‚Üí</span>
            </button>

            <button id="cta-walkthrough" class="btn btn-ghost btn-large" type="button">
              <span class="play-icon">‚ñ∂</span> Watch 10-Minute Walkthrough
            </button>
          </div>

          <div class="hero-tags">
            <span class="pill pill-soft">RAG over policy PDFs</span>
            <span class="pill pill-soft">Hallucination detector</span>
            <span class="pill pill-soft">Citation viewer</span>
          </div>
        </div>

        <div class="hero-right">
          <!-- Fake app card -->
          <div class="app-card">
            <div class="app-header">
              <div class="dots">
                <span class="dot red"></span>
                <span class="dot yellow"></span>
                <span class="dot green"></span>
              </div>
              <span class="app-title">PolicyNavigator AI ‚Äì Streamlit App</span>
            </div>
            <div class="app-body">
              <div class="app-kb">
                <div class="kb-title">Knowledge Base</div>
                <div class="kb-item">
                  <span class="kb-icon">üìÑ</span>
                  <span class="kb-text">Academic_integrity_policyNEU.pdf</span>
                  <span class="kb-status">Indexed</span>
                </div>
              </div>
              <div class="app-qa">
                <div class="qa-label">Ask a Policy Question</div>
                <div class="qa-bubble">
                  What happens if I'm caught cheating on an exam?
                </div>
                <div class="qa-answer">
                  According to the Academic Integrity Policy, cheating on an exam is
                  considered a serious violation. Consequences may include grade
                  penalties, notation on your record, or suspension‚Ä¶
                </div>
              </div>
              <div class="app-metrics">
                <div class="metric-pill">
                  Confidence: <span class="metric-strong">High</span>
                </div>
                <div class="metric-pill">
                  Latency: <span class="metric-strong">1.8s</span>
                </div>
                <div class="metric-pill">
                  Hallucination: <span class="metric-strong">40%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================ FEATURES =================== -->
    <section id="features" class="section section-light">
      <div class="section-header">
        <h2>Everything you need to understand policies</h2>
        <p>
          From simple questions to complex scenarios, PolicyNavigator AI has you
          covered.
        </p>
      </div>

      <div class="feature-grid">
        <article class="card feature-card">
          <div class="card-icon">üí¨</div>
          <h3>Q&amp;A Assistant</h3>
          <p>
            Ask natural-language questions grounded in uploaded policy PDFs,
            with citations, confidence scores, and hallucination warnings.
          </p>
          <button class="card-link scroll-demo">Try it in the demo ‚Üí</button>
        </article>

        <article class="card feature-card">
          <div class="card-icon">ü§î</div>
          <h3>What-If Scenarios</h3>
          <p>
            Describe hypothetical situations and get structured reasoning about how
            policies might apply ‚Äî for learning, not legal advice.
          </p>
          <button class="card-link scroll-demo">Analyze a scenario ‚Üí</button>
        </article>

        <article class="card feature-card">
          <div class="card-icon">üìù</div>
          <h3>Policy Quiz</h3>
          <p>
            Auto-generated MCQs help students actively learn the rules instead of
            passively reading PDFs.
          </p>
          <button class="card-link scroll-demo">Generate a quiz ‚Üí</button>
        </article>

        <article class="card feature-card">
          <div class="card-icon">üìä</div>
          <h3>Synthetic Evaluation</h3>
          <p>
            Synthetic Q&amp;A, similarity, latency, and hallucination metrics to evaluate
            quality and guide prompt / RAG improvements.
          </p>
          <button class="card-link scroll-metrics">See the metrics ‚Üí</button>
        </article>
      </div>
    </section>

    <!-- ================ HOW IT WORKS =================== -->
    <section id="how-it-works" class="section">
      <div class="section-header">
        <h2>How it works</h2>
        <p>A three-step pipeline from document upload to grounded answers.</p>
      </div>

      <div class="steps-grid">
        <div class="card step-card">
          <div class="step-number">01</div>
          <div class="step-icon">‚¨ÜÔ∏è</div>
          <h3>Upload &amp; Index</h3>
          <p>
            Students upload policy PDFs; the system cleans, chunks, and embeds
            them into a vector database.
          </p>
        </div>
        <div class="step-arrow">‚ûú</div>
        <div class="card step-card">
          <div class="step-number">02</div>
          <div class="step-icon">üîé</div>
          <h3>Retrieve &amp; Reason</h3>
          <p>
            We retrieve top-K chunks and use prompt-engineered templates to
            generate grounded answers with citations.
          </p>
        </div>
        <div class="step-arrow">‚ûú</div>
        <div class="card step-card">
          <div class="step-number">03</div>
          <div class="step-icon">‚úÖ</div>
          <h3>Explain &amp; Evaluate</h3>
          <p>
            The UI shows answers, citations, confidence, and hallucination risk.
            Synthetic tests measure accuracy and robustness.
          </p>
        </div>
      </div>

      <div class="arch-wrapper">
        <h3 class="arch-title">System Architecture</h3>
        <div class="arch-flow">
          <span class="arch-pill">User</span>
          <span class="arch-arrow">‚ûú</span>
          <span class="arch-pill">Web UI</span>
          <span class="arch-arrow">‚ûú</span>
          <span class="arch-pill">FastAPI</span>
          <span class="arch-arrow">‚ûú</span>
          <span class="arch-pill">RAG Pipeline</span>
          <span class="arch-arrow">‚ûú</span>
          <span class="arch-pill">LLM</span>
          <span class="arch-arrow">‚ûú</span>
          <span class="arch-pill">Answer + Citations</span>
        </div>
        <p class="arch-caption">
          The same backend powers both this web page and the Streamlit dashboard.
        </p>
      </div>
    </section>

    <!-- ================ LIVE DEMO =================== -->
    <section id="demo" class="section section-light">
      <div class="section-header">
        <div class="section-pill">Interactive Demo</div>
        <h2>Experience PolicyNavigator AI</h2>
        <p>Try out the complete workflow from document upload to intelligent policy analysis.</p>
      </div>

      <div class="demo-streamlit-cta">
        <a href="http://localhost:8501" target="_blank" class="btn btn-primary btn-large">
          Launch Streamlit Demo ‚Üó
        </a>
      </div>

      <!-- Upload / Index -->
      <div class="demo-top-card card">
        <div class="demo-top-header">
          <div class="icon-circle upload">‚¨ÜÔ∏è</div>
          <div style="flex:1;">
            <h3 style="margin:0;">1. Upload Policy Documents</h3>
            <p class="demo-caption">
              Upload PDF, DOCX, or TXT policy files. They are used only for this local demo session.
            </p>
          </div>
          <button id="btn-index" class="btn btn-primary demo-index-btn" type="button">
            Index Documents
          </button>
        </div>

        <label class="file-drop">
          <input id="file-input" type="file" multiple accept=".pdf,.docx,.txt" />
          <div class="file-drop-inner">
            <div class="file-drop-icon">‚òÅÔ∏è</div>
            <div class="file-drop-text">Drag &amp; drop files here or click to browse</div>
          </div>
        </label>

        <div id="file-list" class="file-list"></div>
        <p id="index-status" class="status-text"></p>

        <p class="demo-note" style="margin-top:10px;">
       
        </p>
      </div>

      <!-- Ask question -->
      <div class="demo-middle-card card">
        <div class="demo-top-header">
          <div class="icon-circle question">üí¨</div>
          <div style="flex:1;">
            <h3 style="margin:0;">2. Ask a Policy Question</h3>
            <p class="demo-caption">Enter your question. Answers are grounded in your indexed PDFs.</p>
          </div>
        </div>

        <textarea
          id="question-input"
          class="input-textarea large"
          placeholder="e.g., What is this policy about?"
        ></textarea>

        <div class="demo-controls">
          <div class="demo-control-group">
            <label>Answer style</label>
            <select id="answer-style" class="input-select">
              <option value="Strict policy quote">Strict policy quote</option>
              <option value="Explain my rights (student-friendly)">Explain my rights (student-friendly)</option>
            </select>
          </div>

          <div class="demo-control-group">
            <label>Context chunks (k)</label>
            <input id="k-input" type="number" min="3" max="10" value="5" class="input-number" />
          </div>

          <div class="demo-control-group checkbox-group">
            <input id="rewrite-checkbox" type="checkbox" checked />
            <label for="rewrite-checkbox">Rewrite for retrieval</label>
          </div>
        </div>

        <button id="btn-ask" class="btn btn-primary btn-full" type="button">
          Generate Answer
        </button>

        <!-- Answer + Meta -->
        <div id="qa-result" class="qa-result hidden">
          <div class="qa-layout">
            <div class="qa-main">
              <h4>Answer</h4>
              <p id="answer-text" class="answer-text"></p>
            </div>

            <aside class="qa-side">
              <div class="qa-meta">
                <div class="meta-item">
                  <span class="meta-label">Confidence</span>
                  <span id="confidence-badge" class="meta-badge">‚Äì</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Hallucination risk</span>
                  <span id="hallucination-badge" class="meta-badge">‚Äì</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Latency</span>
                  <span id="latency-label" class="meta-badge">‚Äì</span>
                </div>
              </div>

              <div id="hallucination-warning" class="hallucination-warning hidden">
                ‚ö† High hallucination risk. Please double-check with the official policy documents.
              </div>

              <div class="citations">
                <h4>Citations</h4>
                <div id="citation-list" class="citation-container"></div>
              </div>

              <details id="rewrite-details" class="rewrite-details hidden">
                <summary>See how your question was rewritten</summary>
                <pre id="used-query"></pre>
              </details>
            </aside>
          </div>
        </div>
      </div>

      <!-- What-if scenario: FULL WIDTH (clean) -->
      <div class="demo-middle-card card" style="margin-top:18px;">
        <div class="demo-top-header">
          <div class="icon-circle scenario">üß™</div>
          <div style="flex:1;">
            <h3 style="margin:0;">3. What-If Scenario</h3>
            <p class="demo-caption">Describe a situation and get a structured, policy-grounded analysis.</p>
          </div>
        </div>

        <textarea
          id="scenario-input"
          class="input-textarea large"
          placeholder="e.g., What would happen if a student misses the withdrawal deadline but has documented medical circumstances?"
        ></textarea>

        <button id="btn-scenario" class="btn btn-secondary btn-full" type="button">
          Analyze Scenario
        </button>

        <!-- Cleaner scenario output box (you can beautify CSS later) -->
        <div id="scenario-result-wrap" class="hidden" style="margin-top:14px;">
          <h4 style="margin:0 0 8px;">Scenario Analysis</h4>
          <div
            id="scenario-result"
            style="
              background:#fffdf9;
              border:1px solid #fde7d4;
              border-radius:16px;
              padding:12px 12px;
              font-size:14px;
              line-height:1.6;
              max-height:220px;
              overflow:auto;
              white-space:pre-wrap;
            "
          ></div>
        </div>
      </div>

      <!-- Quiz moved BELOW scenario -->
      <div class="demo-middle-card card" style="margin-top:18px;">
        <div class="demo-top-header">
          <div class="icon-circle quiz">‚ùì</div>
          <div style="flex:1;">
            <h3 style="margin:0;">4. Policy Quiz</h3>
            <p class="demo-caption">Generate quick MCQs from your uploaded policy documents.</p>
          </div>
        </div>

        <div class="demo-control-group" style="max-width:280px;">
          <label for="quiz-count">Number of questions</label>
          <input id="quiz-count" type="number" min="3" max="8" value="4" class="input-number" />
        </div>

        <button id="btn-quiz" class="btn btn-secondary btn-full" type="button">
          Generate Quiz
        </button>

        <div id="quiz-result" class="quiz-result"></div>
      </div>

      <p class="demo-note">
       
      </p>
    </section>

    <!-- ================ METRICS =================== -->
    <section id="metrics" class="section metrics-section">
        <div class="metrics-panel">
          <div class="metrics-head">
            <div class="metrics-pill">Quality & Evaluation</div>
            <h2>We don‚Äôt just eyeball the output ‚Äî we measure it.</h2>
            <p>Automated A/B evaluation on synthetic Q&A with evidence, latency, and hallucination tracking.</p>
          </div>
      
          <div class="metrics-cards">
            <div class="metric-card">
              <div class="metric-top">
                <div class="metric-icon">üìå</div>
                <div class="metric-chip">Improved</div>
              </div>
              <div class="metric-value" id="metric-f1">‚Äî</div>
              <div class="metric-label">Evidence Score</div>
              <div class="metric-sub">Avg max similarity</div>
            </div>
      
            <div class="metric-card">
              <div class="metric-top">
                <div class="metric-icon">‚ö°</div>
                <div class="metric-chip">Runtime</div>
              </div>
              <div class="metric-value" id="metric-latency">‚Äî</div>
              <div class="metric-label">Average Latency</div>
              <div class="metric-sub">Per query response</div>
            </div>
      
            <div class="metric-card">
              <div class="metric-top">
                <div class="metric-icon">üõ°Ô∏è</div>
                <div class="metric-chip">Safety</div>
              </div>
              <div class="metric-value" id="metric-hall">‚Äî</div>
              <div class="metric-label">Hallucination Rate</div>
              <div class="metric-sub">On evaluation questions</div>
            </div>
          </div>
      
          <div class="metrics-detail">
            <div class="ab-head">
              <div>
                <h3>A/B Evaluation Summary</h3>
                <p>Auto-loads <code>results/ab_eval_summary.json</code> (serve via <code>http://</code>).</p>
              </div>
              <div class="ab-badges">
                <span class="ab-badge" id="ab-status">Status: Loading‚Ä¶</span>
              </div>
            </div>
      
            <div class="ab-configs">
              <div class="ab-config-card">
                <div class="ab-config-title">Baseline</div>
                <div class="ab-config-text" id="ab-baseline">‚Äî</div>
              </div>
              <div class="ab-config-card">
                <div class="ab-config-title">Improved</div>
                <div class="ab-config-text" id="ab-improved">‚Äî</div>
              </div>
            </div>
      
            <div class="ab-stats">
              <div class="ab-stat">
                <span>Avg similarity</span>
                <b id="ab-sim">‚Äî</b>
              </div>
              <div class="ab-stat">
                <span>Avg citations</span>
                <b id="ab-cite">‚Äî</b>
              </div>
              <div class="ab-stat">
                <span>Evidence OK rate</span>
                <b id="ab-eok">‚Äî</b>
              </div>
              <div class="ab-stat">
                <span>Latency</span>
                <b id="ab-lat">‚Äî</b>
              </div>
              <div class="ab-stat">
                <span>Hallucination</span>
                <b id="ab-hall">‚Äî</b>
              </div>
            </div>
      
            <div class="ab-footnote">
              Tip: See this in the demo ‚ÄúBaseline vs Improved Retrieval + Query Rewrite + MMR‚Äù.
            </div>
          </div>
        </div>
      </section>
      

    <!-- ================ TEAM & DOCS =================== -->
    <section id="team-docs" class="section section-light">
      <div class="section-header">
        <h2>Behind the project</h2>
        <p>Built by students, for students ‚Äî as part of the Prompt Engineering course at NEU.</p>
      </div>

      <div class="team-docs-grid">
        <div class="team-column">
          <h3 class="column-title">The Team</h3>

          <div class="card team-card">
            <div class="avatar">R</div>
            <div>
              <div class="team-name">Ritwik</div>
              <div class="team-role">Backend, RAG pipeline, synthetic evaluation, metrics, integration.</div>
            </div>
          </div>

          <div class="card team-card">
            <div class="avatar">A</div>
            <div>
              <div class="team-name">Akshaya</div>
              <div class="team-role">UI/UX, prompt design, evaluation harness support, end-to-end demo & docs.</div>
            </div>
          </div>
        </div>

        <div class="docs-column">
          <h3 class="column-title">Resources &amp; Links</h3>

          <div class="docs-grid">
            <a class="card doc-card" href="https://github.com/akshayagavhane9/policynavigator-ai" target="_blank">
              <div class="doc-icon">üêô</div>
              <div>
                <div class="doc-title">GitHub Repository</div>
                <div class="doc-sub">Source code and documentation</div>
              </div>
            </a>

            <a class="card doc-card" href="docs/project_documentation.pdf" target="_blank" rel="noopener noreferrer">
              <div class="doc-icon">üìë</div>
              <div>
                <div class="doc-title">Technical Documentation</div>
                <div class="doc-sub">PDF with architecture details</div>
              </div>
            </a>

            <a class="card doc-card" href="docs/architecture_diagram.png">
              <div class="doc-icon">üß©</div>
              <div>
                <div class="doc-title">Architecture Diagram</div>
                <div class="doc-sub">System design visualization</div>
              </div>
            </a>

            <a class="card doc-card" href="https://drive.google.com/file/d/19p0mJd6X-LtVWKXl-YT6B0tjewDmqusY/view?usp=sharing"
            target="_blank"
            rel="noopener noreferrer">
              <div class="doc-icon">üé•</div>
              <div>
                <div class="doc-title">10-Minute Demo Video</div>
                <div class="doc-sub">Live system demo ‚Ä¢ Architecture ‚Ä¢ Results</div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ================ FOOTER =================== -->
  <footer class="footer">
    <p>PolicyNavigator AI ¬∑ Northeastern University ¬∑ Prompt Engineering Final Project</p>
  </footer>

  <!-- ================= JS ================= -->
  <script>
    const API_BASE = "http://127.0.0.1:8000";

    // ---- Sticky nav active link ----
    const navLinks = document.querySelectorAll(".nav-link");
    navLinks.forEach((link) => {
      link.addEventListener("click", () => {
        navLinks.forEach((l) => l.classList.remove("active"));
        link.classList.add("active");
      });
    });

    // ---- Hero CTA scroll (fix: missing element id before) ----
    const demoSection = document.getElementById("demo");
    const metricsSection = document.getElementById("metrics");

    const ctaDemoBtn = document.getElementById("cta-demo");
    if (ctaDemoBtn) {
      ctaDemoBtn.addEventListener("click", () => {
        demoSection.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    document.querySelectorAll(".scroll-demo").forEach((btn) =>
      btn.addEventListener("click", () =>
        demoSection.scrollIntoView({ behavior: "smooth", block: "start" })
      )
    );

    document.querySelectorAll(".scroll-metrics").forEach((btn) =>
      btn.addEventListener("click", () =>
        metricsSection.scrollIntoView({ behavior: "smooth", block: "start" })
      )
    );

    // ---- File upload UI ----
    const fileInput = document.getElementById("file-input");
    const fileList = document.getElementById("file-list");
    fileInput.addEventListener("change", () => {
      fileList.innerHTML = "";
      const files = Array.from(fileInput.files || []);
      if (!files.length) {
        fileList.textContent = "No files selected yet.";
        return;
      }
      files.forEach((f) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.textContent = "‚Ä¢ " + f.name;
        fileList.appendChild(div);
      });
    });

    // ---- Index documents ----
    const btnIndex = document.getElementById("btn-index");
    const indexStatus = document.getElementById("index-status");

    btnIndex.addEventListener("click", async () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length) {
        indexStatus.textContent = "Please choose at least one file.";
        indexStatus.className = "status-text status-error";
        return;
      }

      const formData = new FormData();
      files.forEach((file) => formData.append("files", file, file.name));

      indexStatus.textContent = "Indexing documents‚Ä¶";
      indexStatus.className = "status-text";

      try {
        const res = await fetch(API_BASE + "/api/index", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();

        // More robust chunk count detection (fixes ‚Äúchunk count not returned‚Äù message)
        const nChunks =
          data.num_chunks ??
          data.n_chunks ??
          data.total_chunks ??
          data.chunks ??
          data.indexed_chunks ??
          null;

        if (Number.isFinite(Number(nChunks)) && Number(nChunks) > 0) {
          indexStatus.textContent =
            "Indexed " + Number(nChunks) + " chunks from " + files.length + " file(s).";
        } else {
          indexStatus.textContent =
            "Indexed successfully for " + files.length + " file(s).";
        }
        indexStatus.className = "status-text status-success";
      } catch (err) {
        console.error(err);
        indexStatus.textContent =
          "Indexing failed. Check that your FastAPI server is running and CORS is enabled.";
        indexStatus.className = "status-text status-error";
      }
    });

    // ---- Ask question ----
    const btnAsk = document.getElementById("btn-ask");
    const qaResult = document.getElementById("qa-result");
    const answerText = document.getElementById("answer-text");
    const confidenceBadge = document.getElementById("confidence-badge");
    const hallucinationBadge = document.getElementById("hallucination-badge");
    const latencyLabel = document.getElementById("latency-label");
    const hallucinationWarning = document.getElementById("hallucination-warning");
    const citationList = document.getElementById("citation-list");
    const usedQueryEl = document.getElementById("used-query");
    const rewriteDetails = document.getElementById("rewrite-details");

    function setConfidenceBadge(label, score) {
      const lower = (label || "").toLowerCase();
      let text = "Low";
      let cls = "badge-low";
      if (lower === "high") {
        text = "High";
        cls = "badge-high";
      } else if (lower === "medium") {
        text = "Medium";
        cls = "badge-medium";
      }
      const safeScore = Number.isFinite(score) ? score : 0;
      confidenceBadge.textContent = text + " (" + safeScore.toFixed(2) + ")";
      confidenceBadge.className = "meta-badge " + cls;
    }

    btnAsk.addEventListener("click", async () => {
      const question = document.getElementById("question-input").value.trim();
      const answerStyle = document.getElementById("answer-style").value;
      const k = parseInt(document.getElementById("k-input").value || "5", 10);
      const rewriteQuery = document.getElementById("rewrite-checkbox").checked;

      if (!question) {
        alert("Please enter a question.");
        return;
      }

      answerText.textContent = "Thinking‚Ä¶";
      qaResult.classList.remove("hidden");
      citationList.innerHTML = "";
      hallucinationWarning.classList.add("hidden");

      try {
        const res = await fetch(API_BASE + "/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question,
            answer_style: answerStyle,
            rewrite_query: rewriteQuery,
            k,
          }),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        answerText.textContent = data.answer || "No answer returned.";

        setConfidenceBadge(data.confidence_label || "low", Number(data.confidence_score || 0));

        const hallucFlag = !!data.hallucination_flag;
        hallucinationBadge.textContent = data.hallucination_risk || (hallucFlag ? "high" : "low");
        hallucinationBadge.className = "meta-badge " + (hallucFlag ? "badge-high" : "badge-medium");

        if (hallucFlag) hallucinationWarning.classList.remove("hidden");
        else hallucinationWarning.classList.add("hidden");

        latencyLabel.textContent = (data.latency_ms || 0) + " ms";

        const citations = data.citations || [];
        if (!citations.length) {
          citationList.innerHTML = "<div class='citation-empty'>No citations returned for this answer.</div>";
        } else {
          citationList.innerHTML = "";
          citations.forEach((c) => {
            const card = document.createElement("div");
            card.className = "citation-card";

            const header = document.createElement("div");
            header.className = "citation-header";

            const sim = Number(c.similarity ?? c.score ?? 0);
            const rawSource = c.source || "";
            const parts = rawSource.split("/");
            const shortSource = parts[parts.length - 1] || rawSource;
            const chunkLabel =
              c.chunk_id !== undefined && c.chunk_id !== null ? ` ‚Ä¢ chunk ${c.chunk_id}` : "";
            const simLabel = Number.isFinite(sim) ? ` ‚Ä¢ sim ${sim.toFixed(2)}` : "";
            header.textContent = `${shortSource}${chunkLabel}${simLabel}`;

            const body = document.createElement("div");
            body.className = "citation-body";

            let txt = (c.text || "").trim().replace(/\\n/g, " ").replace(/\s+/g, " ");
            if (txt.length > 260) txt = txt.slice(0, 260) + "‚Ä¶";
            body.textContent = txt;

            card.appendChild(header);
            card.appendChild(body);
            citationList.appendChild(card);
          });
        }

        const usedQuery = data.used_query || "";
        if (usedQuery) {
          usedQueryEl.textContent = usedQuery;
          rewriteDetails.classList.remove("hidden");
        } else {
          rewriteDetails.classList.add("hidden");
        }
      } catch (err) {
        console.error(err);
        answerText.textContent = "Something went wrong. Check that the backend is running.";
      }
    });

    // ---- Scenario analysis (clean output box) ----
    const btnScenario = document.getElementById("btn-scenario");
    const scenarioInput = document.getElementById("scenario-input");
    const scenarioResultWrap = document.getElementById("scenario-result-wrap");
    const scenarioResult = document.getElementById("scenario-result");

    btnScenario.addEventListener("click", async () => {
      const scenario = scenarioInput.value.trim();
      if (!scenario) {
        alert("Please describe a scenario first.");
        return;
      }

      scenarioResultWrap.classList.remove("hidden");
      scenarioResult.textContent = "Analyzing scenario‚Ä¶";

      try {
        const res = await fetch(API_BASE + "/api/scenario", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ scenario }),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        scenarioResult.textContent = (data.analysis || data.answer || "").trim();
      } catch (err) {
        console.error(err);
        scenarioResult.textContent =
          "Failed to analyze scenario. Ensure /api/scenario exists and backend is running.";
      }
    });

    // ---- Quiz generation ----
    const btnQuiz = document.getElementById("btn-quiz");
    const quizCount = document.getElementById("quiz-count");
    const quizResult = document.getElementById("quiz-result");

    btnQuiz.addEventListener("click", async () => {
      const n = parseInt(quizCount.value || "4", 10);
      quizResult.textContent = "Generating quiz‚Ä¶";

      try {
        const res = await fetch(API_BASE + "/api/quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ num_questions: n }),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const items = data.quiz || data.items || data;

        if (!Array.isArray(items) || !items.length) {
          quizResult.textContent = "No quiz questions returned. Check the backend implementation.";
          return;
        }

        quizResult.innerHTML = "";
        items.forEach((item, idx) => {
          const qCard = document.createElement("div");
          qCard.className = "quiz-question-card";

          const qTitle = document.createElement("div");
          qTitle.className = "quiz-question-title";
          qTitle.textContent = "Q" + (idx + 1) + ". " + (item.question || "");
          qCard.appendChild(qTitle);

          const optionsWrap = document.createElement("div");
          optionsWrap.className = "quiz-options-wrap";
          const options = item.options || [];
          const answer = item.answer || "";
          let selected = null;

          options.forEach((opt, optIdx) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "quiz-option-btn";
            btn.dataset.option = opt;

            const letter = String.fromCharCode(65 + optIdx);
            btn.innerHTML = "<span class='quiz-option-letter'>" + letter + ".</span> " + opt;

            btn.addEventListener("click", () => {
              selected = opt;
              Array.from(optionsWrap.children).forEach((b) => b.classList.remove("selected"));
              btn.classList.add("selected");
            });

            optionsWrap.appendChild(btn);
          });

          qCard.appendChild(optionsWrap);

          const checkBtn = document.createElement("button");
          checkBtn.type = "button";
          checkBtn.className = "quiz-check-btn";
          checkBtn.textContent = "Check Answer";

          const feedback = document.createElement("div");
          feedback.className = "quiz-feedback";

          checkBtn.addEventListener("click", () => {
            if (!selected) {
              feedback.textContent = "Select an option first.";
              feedback.className = "quiz-feedback quiz-feedback-warn";
              return;
            }
            Array.from(optionsWrap.children).forEach((b) => {
              b.classList.remove("correct", "incorrect");
              if (b.dataset.option === answer) b.classList.add("correct");
              else if (b.dataset.option === selected) b.classList.add("incorrect");
            });

            if (selected === answer) {
              feedback.textContent = "‚úÖ Correct!";
              feedback.className = "quiz-feedback quiz-feedback-ok";
            } else {
              feedback.textContent = "‚ùå Not quite. Correct answer: " + answer;
              feedback.className = "quiz-feedback quiz-feedback-bad";
            }

            if (item.explanation) feedback.textContent += " " + item.explanation;
          });

          qCard.appendChild(checkBtn);
          qCard.appendChild(feedback);
          quizResult.appendChild(qCard);
        });
      } catch (err) {
        console.error(err);
        quizResult.textContent = "Failed to generate quiz. Ensure /api/quiz exists on the backend.";
      }
    });
    document.getElementById("cta-walkthrough")?.addEventListener("click", () => {
    window.open(
      "https://drive.google.com/file/d/19p0mJd6X-LtVWKXl-YT6B0tjewDmqusY/view?usp=sharing",
      "_blank",
      "noopener,noreferrer"
    );
    });
    // ---- Metrics: load results/ab_eval_summary.json ----
    async function loadAbSummary() {
      const elF1 = document.getElementById("metric-f1");
      const elLat = document.getElementById("metric-latency");
      const elHall = document.getElementById("metric-hall");

      const st = document.getElementById("ab-status");
      const b0 = document.getElementById("ab-baseline");
      const b1 = document.getElementById("ab-improved");

      const sim = document.getElementById("ab-sim");
      const cite = document.getElementById("ab-cite");
      const eok = document.getElementById("ab-eok");
      const lat = document.getElementById("ab-lat");
      const hall = document.getElementById("ab-hall");

      try {
        const res = await fetch("results/ab_eval_summary.json", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        // Use improved metrics for top cards
        const improved = data.improved || {};
        elF1.textContent = (improved.avg_max_similarity ?? 0).toFixed(2);
        elLat.textContent = Math.round(improved.avg_latency_ms ?? 0) + " ms";
        elHall.textContent = Math.round((improved.hallucination_rate ?? 0) * 100) + "%";

        const notes = data.notes || {};
        b0.textContent = notes.baseline_config || "‚Äî";
        b1.textContent = notes.improved_config || "‚Äî";

        // A/B detail summary (focus on improved)
        sim.textContent = (improved.avg_max_similarity ?? 0).toFixed(3);
        cite.textContent = String(improved.avg_citations_count ?? "‚Äî");
        eok.textContent = Math.round((improved.evidence_ok_rate ?? 0) * 100) + "%";
        lat.textContent = Math.round(improved.avg_latency_ms ?? 0) + " ms";
        hall.textContent = Math.round((improved.hallucination_rate ?? 0) * 100) + "%";

        st.textContent = "Status: Loaded ‚úì";
      } catch (err) {
        console.warn("[metrics] could not load ab_eval_summary.json:", err);
        document.getElementById("ab-status").textContent =
          "Status: Could not load summary. Serve this site over http:// and ensure results/ab_eval_summary.json exists.";
      }
    }

    loadAbSummary();
  </script>
</body>
</html>
